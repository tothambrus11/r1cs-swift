name: Linux Compatibility

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  linux-test:
    name: Test on ${{ matrix.container }}
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        container:
          - swift:5.9-focal
          - swift:5.10-jammy  
          - swift:6.0-jammy
    
    container:
      image: ${{ matrix.container }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Print system info
      run: |
        uname -a
        swift --version
        cat /etc/os-release
    
    - name: Resolve dependencies
      run: swift package resolve
    
    - name: Build package
      run: swift build --verbose
    
    - name: Run tests
      run: swift test --verbose
    
    - name: Build for release
      run: swift build -c release --verbose

  cross-platform-test:
    name: Cross Platform Build Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: 6.0
    
    - name: Test different architectures
      run: |
        # Test that the package builds correctly
        swift build
        swift test
        
        # Verify package structure
        swift package describe --type json > package-description.json
        cat package-description.json
        
        # Check for any platform-specific issues
        if grep -r "import Foundation" Sources/; then
          echo "✓ Foundation imports found - good for Linux compatibility"
        fi
        
        if grep -r "#if os(macOS)" Sources/; then
          echo "⚠️  Platform-specific macOS code found - review for Linux compatibility"
          exit 1
        fi